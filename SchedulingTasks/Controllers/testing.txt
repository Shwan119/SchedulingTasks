$(document).ready(function() {
            var selectedItems = new Set();
            var originalSelectedItems = new Set();
            
            // Initialize modal when opened
            $('#tableModal').on('show.bs.modal', function() {
                initializeSelections();
                resetModal();
                updateSaveButton();
            });
            
            // Initialize selections from pre-checked checkboxes
            function initializeSelections() {
                selectedItems.clear();
                originalSelectedItems.clear();
                
                // Get pre-checked items from DB using id
                $('.item-checkbox:checked').each(function() {
                    var id = parseInt($(this).attr('id'));
                    selectedItems.add(id);
                    originalSelectedItems.add(id);
                    $(this).closest('tr').addClass('selected');
                });
            }
            
            // Restore original DB selections
            function restoreOriginalSelections() {
                selectedItems.clear();
                $('.item-checkbox').prop('checked', false);
                $('#tableBody tr').removeClass('selected');
                
                // Restore original selections using id
                originalSelectedItems.forEach(function(id) {
                    selectedItems.add(id);
                    var checkbox = $('.item-checkbox[id="' + id + '"]');
                    checkbox.prop('checked', true);
                    checkbox.closest('tr').addClass('selected');
                });
                
                updateSaveButton();
            }
            
            // Search functionality
            $('#searchInput').on('input', function() {
                var searchTerm = $(this).val().toLowerCase();
                
                if (searchTerm === '') {
                    $('#tableBody tr').removeClass('custom-hidden');
                    $('#searchResults').addClass('custom-hidden');
                } else {
                    var visibleCount = 0;
                    
                    $('#tableBody tr').each(function() {
                        var row = $(this);
                        var title = row.find('.title-cell').text().toLowerCase();
                        var ait = row.find('.ait-badge').text().toLowerCase();
                        
                        if (title.includes(searchTerm) || ait.includes(searchTerm)) {
                            row.removeClass('custom-hidden');
                            visibleCount++;
                        } else {
                            row.addClass('custom-hidden');
                        }
                    });
                    
                    $('#searchResults')
                        .text('Found ' + visibleCount + ' result' + (visibleCount !== 1 ? 's' : ''))
                        .removeClass('custom-hidden');
                }
                
                var hasVisibleRows = $('#tableBody tr:not(.custom-hidden)').length > 0;
                if (hasVisibleRows) {
                    $('#noResults').addClass('custom-hidden');
                    $('#itemsTable').removeClass('custom-hidden');
                } else {
                    $('#noResults').removeClass('custom-hidden');
                    $('#itemsTable').addClass('custom-hidden');
                }
            });
            
            // Individual checkbox change
            $(document).on('change', '.item-checkbox', function() {
                var id = parseInt($(this).attr('id'));
                var row = $(this).closest('tr');
                
                if ($(this).is(':checked')) {
                    selectedItems.add(id);
                    row.addClass('selected');
                } else {
                    selectedItems.delete(id);
                    row.removeClass('selected');
                }
                
                updateSaveButton();
            });
            
            // Update save button enable/disable state
            function updateSaveButton() {
                var saveButton = $('#saveSelection');
                
                if (selectedItems.size === 0) {
                    saveButton.prop('disabled', true);
                } else {
                    saveButton.prop('disabled', false);
                }
            }
            
            function resetModal() {
                $('#searchInput').val('');
                $('#searchResults').addClass('custom-hidden');
                $('#tableBody tr').removeClass('custom-hidden');
            }
            
            // Reset on modal close - restore original selections
            $('#tableModal').on('hidden.bs.modal', function() {
                restoreOriginalSelections();
            });
            
            // Public function to get selected items (for your old implementation)
            window.getSelectedItems = function() {
                return Array.from(selectedItems);
            };
            
            // Example of how to use with your old save implementation
            $('#saveSelection').on('click', function() {
                var selectedIds = getSelectedItems();
                console.log('Selected IDs:', selectedIds);
                
                // Call your existing save function here
                // yourExistingSaveFunction(selectedIds);
                
                alert('Selected IDs: ' + selectedIds.join(', '));
                $('#tableModal').modal('hide');
            });
        });